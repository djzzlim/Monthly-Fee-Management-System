{% extends "share/dashboard.html" %}

{% block title %}Class Payment Status{% endblock %}
{% block card_header %}bg-primary{% endblock %}
{% block card_title %}Class Payment Status{% endblock %}

{% block card_content %}
<div class="container mt-4">
    <h4>Class Payment Status</h4>

    <!-- Class Filter with View Statistics Button -->
    <div class="d-flex justify-content-between mb-3">
        <form method="GET" class="d-flex">
            <label for="class_name" class="form-label me-2">Select Class:</label>
            <select id="class_name" name="class_name" class="form-select" onchange="this.form.submit()">
                <option value="">All Classes</option>
                {% for class_name in class_names %}
                    <option value="{{ class_name }}" {% if class_name == selected_class %}selected{% endif %}>{{ class_name }}</option>
                {% endfor %}
            </select>
        </form>

        <!-- Button for statistics -->
        <button class="btn btn-info" onclick="showStatistics()">View Statistics</button>
    </div>

    <!-- Payment Status Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Class</th>
                <th>Amount Due</th>
                <th>Paid Amount</th>
                <th>Payment Status</th>
            </tr>
        </thead>
        <tbody>
            {% if payments %}
                {% for payment in payments %}
                    <tr>
                        <td>{{ payment.student_name }}</td>
                        <td>{{ payment.class_name }}</td>
                        <td>RM {{ payment.amount_due }}</td>
                        <td>RM {{ payment.paid_amount }}</td>
                        <td>
                            {% if payment.payment_status == "Not Paid" %}
                                <span class="text-danger">{{ payment.payment_status }}</span>
                            {% elif payment.payment_status == "Partially Paid" %}
                                <span class="text-warning">{{ payment.payment_status }}</span>
                            {% elif payment.payment_status == "Paid" %}
                                <span class="text-success">{{ payment.payment_status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="text-center">No records found.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Payment Statistics Modal -->
    <div id="statisticsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h4>Payment Statistics</h4>
            <div class="d-flex justify-content-between">
                <div>
                    <p>Total Students: <strong>{{ total_students }}</strong></p>
                    <p>Fully Paid: <strong>{{ fully_paid_percentage }}</strong></p>
                    <p>Partially Paid: <strong>{{ partially_paid_percentage }}</strong></p>
                    <p>Not Paid: <strong>{{ not_paid_percentage }}</strong></p>
                </div>
                <div>
                    <canvas id="paymentChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Show modal
    function showStatistics() {
        const modal = document.getElementById("statisticsModal");
        modal.style.display = "block";

        // Generate the chart
        const ctx = document.getElementById("paymentChart").getContext("2d");
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Fully Paid', 'Partially Paid', 'Not Paid'],
                datasets: [{
                    data: [
                        {{ fully_paid_percentage }},
                        {{ partially_paid_percentage }},
                        {{ not_paid_percentage }}
                    ],
                    backgroundColor: ['#28a745', '#ffc107', '#FF0000'],
                    hoverOffset: 4 
                }] 
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    // Close modal
    function closeModal() {
        const modal = document.getElementById("statisticsModal");
        modal.style.display = "none";
    }
</script>

<!-- Modal Styling -->
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 1000px;
        text-align: center;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .d-flex {
        display: flex;
    }
    .justify-content-between {
        justify-content: space-between;
    }
</style>
{% endblock %}
