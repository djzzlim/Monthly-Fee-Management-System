{% extends "share/dashboard.html" %}

{% block title %}
    Make Payment
{% endblock %}

{% block card_header %}
    bg-warning
{% endblock %}

{% block card_title %}
    Make Payment
{% endblock %}

{% block card_content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if payment_successful %}
        <p class="alert alert-success">Payment successful!</p>
    {% elif no_payment_due %}
        <p class="alert alert-info">No payment due currently.</p>
    {% else %}
        <p>Make a payment for: <strong>{{ selected_child.first_name }} {{ selected_child.last_name }}</strong></p>

        <form method="POST" action="{{ url_for('parent.make_payment') }}">
            <div class="mb-3">
                <label for="fee_payment" class="form-label">Select Fee Payment</label>
                <select class="form-select" id="fee_payment" name="fee_payment" required onchange="updateAmount()">
                    {% for fee in unpaid_fees %}
                        <option value="{{ fee.fee_record_id }}" data-amount="{{ fee.total_amount }}" data-penalty="{{ fee.late_fee_amount }}">
                            Invoice ID: invoice_{{ fee.fee_record_id }} - Due: RM {{ fee.total_amount }}  
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="amount" class="form-label">Amount Due</label>
                <input type="text" class="form-control" id="amount" name="amount" value="RM {{ fee_record.total_amount if fee_record else '0' }}" readonly>
            </div>

            <div class="mb-3">
                <label for="penalty" class="form-label">Penalty</label>
                <input type="text" class="form-control" id="penalty" value="RM {{ total_penalty }}" readonly>
            </div>

            <div class="mb-3">
                <label for="payment_method" class="form-label">Payment Method</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="Credit Card">
                    <label class="form-check-label" for="Credit Card">
                        Credit Card
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="Bank Transfer">
                    <label class="form-check-label" for="Bank Transfer">
                        Bank Transfer
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="e_wallet" value="E-Wallet">
                    <label class="form-check-label" for="E-Wallet">
                        E-Wallet
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Submit Payment</button>
        </form>
    {% endif %}

    <a href="{{ url_for('parent.dashboard') }}" class="btn btn-secondary mt-3">Back to Dashboard</a>

    <script>
        function updateAmount() {
            var selectedOption = document.getElementById("fee_payment").selectedOptions[0];
            document.getElementById("amount").value = "RM " + selectedOption.getAttribute("data-amount");
            document.getElementById("penalty").value = "RM " + selectedOption.getAttribute("data-penalty");
        }

        document.querySelector('form').addEventListener('submit', function(event) {
            var paymentMethodSelected = document.querySelector('input[name="payment_method"]:checked');
            var errorDiv = document.getElementById("payment-error");

            if (!paymentMethodSelected) {
                errorDiv.textContent = "Please select a payment method before submitting.";
                errorDiv.classList.remove("d-none"); // Show error message
                event.preventDefault(); // Prevent form submission
            } else {
                errorDiv.classList.add("d-none"); // Hide error if fixed
            }
        });
    </script>
    
{% endblock %}
