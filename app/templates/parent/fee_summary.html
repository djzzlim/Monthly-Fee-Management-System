{% extends "share/dashboard.html" %}

{% block content %}
  {% block title %}
    Fee Summary
  {% endblock %}

  {% block card_header %}
    bg-primary
  {% endblock %}

  {% block card_title %}
    Fee Summary
  {% endblock %}

  {% block card_content %}
  <p>
    Viewing fee summary for: <strong>{{ selected_child.first_name }} {{ selected_child.last_name }}</strong>
  </p>

  <!-- Summary Box -->
  <div class="card mb-4">
    <div class="card-header" style="background-color: #7aacf8;">
      <h5>Summary</h5>
    </div>
    <div class="card-body">
      <p><strong>Total Amount Due:</strong> RM {{ total_amount_due }}</p>
      <p><strong>Total Penalty:</strong> RM {{ total_penalty }}</p>
      <p><strong>Total Amount (Including Penalty):</strong> RM {{ total_amount_with_penalty }}</p>
    </div>
  </div>

  <!-- Check if there are any unpaid fees -->
  {% set unpaid_fees = fee_records | selectattr('status.status_id', 'in', ['status001', 'status003']) | list %}

  {% if unpaid_fees %}
    <!-- Fee Details Table -->
    <h5>Fee Details:</h5>
    <table class="table">
      <thead>
        <tr>
          <th>No.</th>
          <th>Invoice ID</th>
          <th>Amount Due (RM)</th>
          <th>Due Date</th>
          <th>Penalty (RM)</th>
          <th>Exceeded Days</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for fee in unpaid_fees %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>invoice_{{ fee.fee_record_id }}</td>
            <td>RM {{ fee.amount_due }}</td>
            <td>{{ fee.due_date.strftime('%Y-%m-%d') if fee.due_date else 'N/A' }}</td>
            <td>RM {{ fee.late_fee_amount or 0 }}</td>
            <td>{{ (current_date - fee.due_date).days if fee.due_date and current_date > fee.due_date else 0 }}</td>
            <td>
              {% if fee.status.status_id == "status001" %}
                Pending
              {% elif fee.status.status_id == "status003" %}
                Overdue
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <!-- Display message if all fees are paid -->
    <p class="alert alert-info">No payment due currently.</p>
  {% endif %}

  <hr>

  <a href="{{ url_for('parent.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>

  {% endblock %}
{% endblock %}